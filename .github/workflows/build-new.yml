name: (NEW) Build PyDMX Buildroot OS for RPi4
on:
    workflow_dispatch:

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
          - name: Checkout repository
            uses: actions/checkout@v4

          - name: Install dependencies
            run: |
              sudo apt-get update
              sudo apt-get install -y build-essential gcc g++ make libc6-dev git rsync wget cpio unzip python3 protobuf-compiler

          - name: Generate protobuf 3.21.12 hash
            run: |
              # Download Protobuf 3.21.12
              wget https://github.com/protocolbuffers/protobuf/releases/download/v3.21.12/protobuf-cpp-3.21.12.tar.gz

              # Compute SHA256 hash
              HASH=$(sha256sum protobuf-cpp-3.21.12.tar.gz | awk '{print $1}')

              echo "Computed hash: $HASH"

              # Write hash file for Buildroot
              mkdir -p package/protobuf
              cat <<EOF > package/protobuf/protobuf.hash
# Automatically generated by GitHub Actions
sha256  $HASH  protobuf-cpp-3.21.12.tar.gz
EOF

          - name: Clear Output directory
            run: |
              rm -rf output

          - name: Make fake expr for OLAD executable
            run: |
              chmod +x package/olad/fakebin/expr

          - name: Build
            run: |
              make

          - name: Upload System Images
            uses: actions/upload-artifact@v4
            with:
              name: buildroot-images
              path: output/images
