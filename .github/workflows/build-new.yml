name: (NEW) Build PyDMX Buildroot OS for RPi4
on:
    workflow_dispatch:

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
          - name: Checkout repository
            uses: actions/checkout@v4

          - name: Install dependencies
            run: |
              sudo apt-get update
              sudo apt-get install -y build-essential gcc g++ make libc6-dev git rsync wget cpio unzip python3 protobuf-compiler

          - name: Generate protobuf 3.21.12 hashes (tarball + LICENSE)
            run: |
              # Download Protobuf 3.21.12 and download from debian since google doesn't store that old versions anymore
              wget https://deb.debian.org/debian/pool/main/p/protobuf/protobuf_3.21.12.orig.tar.gz

              # Compute tarball hash
              TARBALL_HASH=$(sha256sum protobuf_3.21.12.orig.tar.gz | awk '{print $1}')
              echo "Tarball hash: $TARBALL_HASH"

              # Extract LICENSE file
              mkdir proto_extract
              tar -xzf protobuf_3.21.12.orig.tar.gz -C proto_extract

              # Find LICENSE (protobuf uses LICENSE)
              LICENSE_PATH=$(find proto_extract -maxdepth 2 -name LICENSE | head -n 1)

              # Compute LICENSE hash
              LICENSE_HASH=$(sha256sum "$LICENSE_PATH" | awk '{print $1}')
              echo "LICENSE hash: $LICENSE_HASH"

              # Write hash file for Buildroot
              mkdir -p package/protobuf
              cat <<EOF > package/protobuf/protobuf.hash
              echo "# Automatically generated by GitHub Actions" > package/protobuf/protobuf.hash
              echo "sha256 $LICENSE_HASH LICENSE" >> package/protobuf/protobuf.hash
              echo "sha256 $TARBALL_HASH protobuf_3.21.12.orig.tar.gz" >> package/protobuf/protobuf.hash

          - name: Clear Output directory
            run: |
              rm -rf output

          - name: Make fake expr for OLAD executable
            run: |
              chmod +x package/olad/fakebin/expr

          - name: Build
            run: |
              make

          - name: Upload System Images
            uses: actions/upload-artifact@v4
            with:
              name: buildroot-images
              path: output/images
